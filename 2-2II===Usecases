%NEW 2) DESIGN
%\section{Design} PLAN
%	\subsection{Choice of the simulation tool}
%	\subsection{Modules} %la feuille de brouillon rose
%	\subsection{Computational models} 
%	\subsection{Design issues} %mettre problemes de conception généraux et ceux specifiques a certains outils

	


%NEW 2) DESIGN
% BEGINNING

\section{Design}
	\subsection{Choice of the simulation tool}
\label{sec:toolsConstraints}
It was possible to choose a technology among the ones I already knew (Python~\cite{pythonWebsite}, Unity3D~\cite{Unity3DWebsite} ) and others I investigated about. The two main virtual worlds existing nowadays are OpenSimulator and Second Life. 
\\The choice was made according to two criteria: the tool should give enough freedom to code all what is needed for this prototype, and the technology should enable a reasonably short time of development.
\\Table \ref{tab:toolChoice} summarizes the characteristics of each tool:

\begin{table}
\caption{Comparizon between different 3D development tools}
\label{tab:toolChoice}
\resizebox{\textwidth}{!}{%
    \begin{tabular}{|l|llll|}
    \hline
    ~                              & OpenSimulator & Second Life & Unity 3D (game engine) & Python (library) \\ \hline
    Engines (physical, network...) & Yes           & Yes         & Yes                    & Yes              \\ \hline
    Available content              & Yes           & Yes         & A little                    & No               \\ \hline
    Multiplayer                    & Yes           & Yes         & Yes                    & ~                \\ \hline
%    Time to learn the language     & 1             & 1           & 0                      & 0                \\ \hline
    Development time               & Short             & Short           & Medium                      & Long                \\ \hline
    Restrictions                   & Yes           & Yes         & Yes and No             & No               \\ \hline
    Documentation and community    & Yes           & Yes +       & Yes                    & Yes              \\ \hline
    Open source                    & Yes           & No          & No                     & Yes              \\ \hline
    Used in education              & Yes +         & Yes         & -                      & -                \\ \hline
    Scripting                      & Yes           & Yes         & Yes                    & Yes              \\ \hline
    \end{tabular}}
    
\end{table}


OpenSimulator and Second life have really close characteristics: a reduced development time, and some already available content. Developing with Unity3D or with a Python 3D library would be longer because nothing is prebuilt.\\

    We chose OpenSimulator because it is open source, and increasingly used in education while Second Life is more business related. Moreover, Second Life suffered from a certain adverse publicity.

\begin{figure}[h]
        %\centering
        \begin{subfigure}[b]{0.4\textwidth}
                \centering
                \includegraphics[scale=0.43]{sWEB}
                \caption{Internet, client and server}
                \label{fig:sWEB}
        \end{subfigure}
        \begin{subfigure}[b]{0.4\textwidth}
                \centering
                \includegraphics[scale=0.43]{sOS}
                \caption{Opensimulator, client and server}
                \label{fig:sOS}
        \end{subfigure}
        
        \caption{Analogy between Internet and Virtual Worlds like Opensimulator}
        \label{fig:analogy}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


	\subsection{Modules} %la feuille de brouillon rose
	

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% NOUVEAU TITRE
%\subsection{Computational models} 

% VIEUX TITRE, A CHANGER
%\section{The Glucose-Insulin underlying model}
\subsection{The Glucose-Insulin underlying model}

\label{sec:mymodelSection}
    
A model describing the evolution of blood glucose depending on the intakes of food and insulin is needed for two reasons.

%OLD \subsection{Model requirements}
\subsubsection{Model requirements}

\paragraph{}
The 3D simulation of the symptoms and physical condition needs a model, roughly based on the biological mechanisms. This model doesn't to be exactly accurate, because we need it only to trigger hypos, hypers or abilities to do a range of actions. As an example of ability, we can mention that the less sugar the avatar has (below a given threshold), the hardest it will be for him to run or dance in a party.
\paragraph{}
The model will also be needed for the web interface, in which rates and graphs would be displayed so that teenagers that are using the application will be able to see the consequences of having a meal, an insulin injection, or any kind of activity in real time. This will give them a better understanding of how insulin works and how sugars are used, especially along the time. This model do need a certain precision as they are supposed to use it to understand better the underlying mechanisms of diabetes. However, the educational aspect here is also more important than the accuracy needed. For instance, if the complex phenomenon x and y are involved in the process, and other parameters A, B and C has an influence on it, x and y phenomenon won't be modelled nor considered as parameters of our model if they don't need to be known by the adolescents.  

%OLD \subsection{Computational Model}
\subsubsection{Computational Model}
The following model tries to meet the requirements described above. As expected, the key variable of this model is glucose. On one hand, we try to estimate realistically his evolution according to the known amounts of glucose eaten by the avatar, insulin intakes, energy consumption. On the other hand, the biological mechanisms should be 

At this point of the project, we don't expect accurate nor complete realistic blood values, because the first use of this model will be done for the "in-game" simulation, eg the simulation of the symptoms and activities in the 3D environment. We should also specify that time in the simulation will be speeded. For this reason, blood glucose and insulin evolution over time won't be the same as the real life ones, which support the fact that a good agreement with experimental medical data is not needed. 

$GlucoseB$ is the glucose in the blood, $p_{activity}$ and $p_{food}$ are the characteristic parameters respectively for a given activity and for a given type of food.$x$ is a quantity of intake (food or insulin).
 %#todo talk about the links between this model and bergman's%
\paragraph{}

$\begin{array}{l l}
    GlucoseB(t) = & \quad  GlucoseB(t-1) + GlucoseFromFood(t, p_{food}, x_{food})\\  & \quad + GlucoseReleased(t)
    - GlucoseConsumption(t, state, p_{activity})\\  & \quad - InsulinEffect(t, x_{insulin})\\
  \end{array}$

\paragraph{}
With $p_{activity}$ = $\left\{ 
  \begin{array}{l l}
    \tau & \quad \textrm{fonction's period}\\
    Activity(t) & \quad \textrm{the fonction describing how glucose is used }\\
    t_{0} & \quad \textrm{time when the activity began}
  \end{array} \right.$
  
and $p_{food}$ = $\left\{ 
  \begin{array}{l l}
    \tau & \quad \textrm{fonction's period}\\
    Food(t) & \quad \textrm{the fonction describing how glucose is released }\\
    t_{0} & \quad \textrm{time when food is eaten}
  \end{array} \right.$

\paragraph{}
InsulinEffect(t,$x_{insulin}$) describes the part of glucose removed from the bloodstream to be stored (mainly in the liver, in the form of glucagon).
  
The previous model can be detailed 
\paragraph{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\small
$\begin{array}{l l l}
    GlucoseB(t) = 
        & \quad GlucoseB(t-1)      & \quad \textrm{glucose already there}\\
        
        & \quad + \displaystyle \sum_{\substack{i\in \textrm{food eaten}  }} x_{i}*Food(t-t_{0}_{i})    
* Step(t – t_{0}_{i} - \tau_{i})        & \quad \textrm{glucose released by each food}\\

        & \quad +GlucoseRel(t-t_{0}) * Step(Gmax-G(t-1))      & \quad \textrm{glucose released by liver}\\
        & \quad -BaselineActivity(state)      & \quad \textrm{glucose used for `basal' living}\\
        & \quad -\displaystyle \sum_{\substack{
   i\in \textrm{activities}  }}     Activity_{i}(t-t_{0}_{i}) * Step(t – t_{0}_{i} - \tau_{i}     & \quad \textrm{activities and sports}\\
        & \quad -$\alpha$(meal) * Insulin(t-t_{0}) * Step(t – t_{0} – \tau_{i})      & \quad \textrm{insulin action on glucose}
  \end{array}$
  \normalsize
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\paragraph{}
where 
  $\left\{ 
  \begin{array}{l l}
    state & \quad \textrm{avatar's state: awake or sleeping}\\
    $\alpha$(meal) & \quad \textrm{given a meal time, amount of glucose removed per unit of insulin}\\
    Step(x) & \quad \textrm{step function, whose value is zero for negative argument and}\\ & \quad \textrm{ one for positive argument }
  \end{array} \right.$

\paragraph{}
The step function allows us to use any kind of mathematical function to describe $Activity$, $GlucoseRel$ or $Insulin$. Indeed, we only take the restriction of the function we are interested in.

For instance, \\
        	=> muscles, liver, fat\\
	where :\\
Step(t) =  1 if t>=0\\
	    0 if t<0\\
Redistributor :\\
1)muscles	value in g. each second\\
2)liver		400g. max %check\\
3)fat		40g sugar = 30g fat #find, use a factor to set it\\


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	
	\subsection{Design issues} 
%mettre problemes de conception généraux et ceux specifiques a certains outils

%OLD \subsection{Design}

\subsubsection{Notifications : the Energy Bar}
Knowing the educational purpose of the simulation, certain information need to be displayed in a relevant way so that the user can understand the consequences of his actions. Available information includes:
\begin{itemize}
\item glucose blood level (and the normal values)
\item insulin blood level
\item liver glucose
\item the ``amount'' of energy consumed by an activity.
\end{itemize}

A large amount of other variables is available, but on the contrary of software simulation tools based on graphs and values such as Aida, I choosed to display only a small quantity of information
% (WHY ? REMOVE OR JUSTIFY THE CHOICE: 
%, with a maximum of 3 values. 
. It doesn't make sense to put all the indicators on the screen of the 3D simulation because an overloaded interface would decrease the interest of the teenage final users, according to what was said in the analysis of the Aida tool % in reference ... 
(or in the guidelines section).


Users should be aware of the impacts of:
\begin{itemize}
\item the food they eat on their glycemic system
\item the effects of physical activity on blood levels
\item how insulin-based blood sugar management impacts the avatar's behavior, from restrictions in avatar's activities and symptoms to unconsciousness (~\ref{fig:unc})
\end{itemize}

\begin{figure}[h]
  \caption{Avatar lying on the bed}
  \centering
  \includegraphics[scale=0.4]{Sleeping_001.png}
  \label{fig:unc}
\end{figure}

For this purpose, the key point is to display indicators at some moments, and to make a good use of colors.% especially when we will add a system dealing with "long term indicators". These new indicators may include values such as glycated hemoglobin, fitness, global comfort, psychological health.%

%suite available... (in old)

In order to keep the relevance of blood testing, it is necessary to avoid displaying blood glucose on screen. The user need to perform test his blood in world, by using a glucose meter, to get this value. Else, blood testing could be avoided by users which is undesirable because it is a main part of the diabetic's daily routine.\\

An energy bar, varying from red to green, will represent the amount of "available" energy. In case of hypoglycemia, there is little energy so the bar is red. With the amount of glucose building up, the bar will change into green. However, if there is no insulin that can be used by the blood, even with a high blood sugar, the energy won't be available and the bar will be orange, or even red in case of a very strong hyperglycemia. This bar is always visible on the top of the screen.